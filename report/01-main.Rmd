
```{r fig-map, fig.cap="Map of the management areas 5AB (Queen Charlotte Sound), 5CD (Hecate Strait), and 3CD (West Coast Vancouver Island).", out.width="4in"}
knitr::include_graphics(here::here("report/figure/Pcod_3CD5ABCDE_Pic.png"))

```

\clearpage

# Introduction

The last Pacific Cod assessment was conducted in 2018 [@forrest2020; @dfo2019]. Separate assessments were provided for stocks in Area 3CD and Area 5ABCD (Figure \@ref(fig:fig-map)).
The assessment models were delay-difference models, fit to survey indices, commercial catch-per-unit-effort (CPUE), commercial catch data and commercial annual mean weights.
Survey indices were available to 2016 for Area 3CD and 2017 for Area 5ABCD. Both stocks were assessed to be in the Cautious Zone [@dfo2009].

Since the last advice [@dfo2019], there has been no further request for science advice. However, it has recently come to our attention that the 2018 survey index for Area 3CD was very low, approximately 25% of the previous two observations (Figure \@ref(fig:fig-wcvi-index-3cd)).
The commercial CPUE index has also decreased since 2016 (Figure \@ref(fig:fig-cpue-index-3cd)). Catches in 2018 and 2019 in Area 3CD were also very low (Table \@ref(tab:tab-catch-3cd), Figure \@ref(fig:fig-catch-3cd)).

While we did not see a decrease in survey or CPUE indices for either Hecate Strait or Queen Charlotte Sound (Figure \@ref(fig:surv-canadian)), which cover the Area 5ABCD stock, we have taken the opportunity to update all the data streams for both Areas 3CD and 5ABCD and re-run the stock assessment to re-assess stock status.

```{r get-recent-3CD-index-data}

#CPUE
params <- list()
params$species_proper <- "Pacific Cod"
params$april1_year <- TRUE
params$area <- c("5[ABCD]+", "3[CD]+")
params$area_name <- c("5ABCD", "3CD")
params$skip_single_variable_models <- FALSE

params$era <- "modern"
source(here::here("R/cpue.R"))
dfleet_modern <- dfleet
gg_cpue_modern <- gg_cpue
cpue_pred_modern <- predictions
arith_cpue_modern <- arith_cpue

#Survey
surv.file <- here::here("data/generated/all_surveys.csv")

if(!file.exists(surv.file)){
  message("Error: Survey indices file has not been made! Please run 04-survey-indices-app.Rmd first.")
} else {
  surv_index <- readr::read_csv(here::here("data/generated/all_surveys.csv"))
}

```


```{r fig-wcvi-index-3cd, fig.cap="West Coast Vancouver Island Synoptic Survey estimates, centred by geometric mean", echo=FALSE}

g <- surv_index %>%  
  rename("Survey"= "Survey abbrev.", "Lower" = "Lower CI", "Upper"="Upper CI") %>%   dplyr::filter(Survey=="SYN WCVI") %>% 
  select(Survey, Year,Biomass, CV) %>%
  mutate("GeometricMean"= Biomass/exp(mean(log(Biomass)))) %>%
  mutate("LowerG" = exp(log(GeometricMean))-2*CV, "UpperG"=exp(log(GeometricMean))+2*CV) %>%   ggplot(aes(Year, GeometricMean)) + 
  geom_pointrange(aes(ymin=LowerG, ymax=UpperG))+
  theme_pbs() +
  ylab("WCVI Survey Index (centred by its geometric mean)")+
  xlab("Year") 
g


```


```{r fig-cpue-index-3cd, fig.cap="Commercial CPUE estimates, centred by geometric mean", echo=FALSE}

g <- cpue_pred_modern %>%
  dplyr::filter(formula_version=="Full standardization", area=="3CD") %>%
  select(year, est,se_link) %>%
  mutate("GeometricMean"= est/exp(mean(log(est)))) %>%
  mutate("LowerG" = exp(log(GeometricMean))-2*se_link, "UpperG"=exp(log(GeometricMean))+2*se_link) %>% 
  ggplot(aes(year, GeometricMean)) + 
  geom_pointrange(aes(ymin=LowerG, ymax=UpperG))+
  theme_pbs() +
  ylab("Comm. CPUE (centred by its geometric mean)")+
  xlab("Year") 
g

```


```{r fig-iphc-index-3cd}
#this is not very useful but keep the code so we know how to get iphc data in future

# # Need to check which areas are included. May need to filter data first to be only 3CD,
# # then plot either series C or D (which are coastwide)
# iphc.3CD <- iphc.dat %>% 
#   filter(lat <50.7) #the border of 3D is actually 50.5 but not enough obs if that is used 
# 
# # iphc.3CD$ser_longest is series C (does not filter for > 50.6 degrees)
# glist <- gfiphc::calc_iphc_full_res(iphc.3CD) 
# 
# g <- glist$ser_longest %>% 
#   select(year, I_tBootMean, I_tBootCV) %>%
#   mutate("GeometricMean"= I_tBootMean/exp(mean(log(I_tBootMean)))) %>%
#   mutate("LowerG" = exp(log(GeometricMean))-2*I_tBootCV, "UpperG"=exp(log(GeometricMean))+2*I_tBootCV) %>% 
#   ggplot(aes(year, GeometricMean)) + 
#   geom_pointrange(aes(ymin=LowerG, ymax=UpperG))+
#   theme_pbs() +
#   ylab("IPHC FISS (centred by its geometric mean)")+
#   xlab("Year") 
# g 
#   

```


# Methods

**TODO: Add a bare minimum description of the methods, referring to previous assessment**

## Data

Data were extracted from DFO databases in the same way as described in @forrest2020, with updates to 2019. The models were fit to:

1. Commercial catch data (Tables \@ref(tab:tab-catch-3cd) and \@ref(tab:tab-catch-5abcd), Figures \@ref(fig:fig-catch-3cd) and \@ref(fig:fig-catch-5abcd)); 

2. Survey indices of abundance. The 3CD model was fit to the WCVI Synoptic Survey (Figure \@ref(fig:surv-canadian)) and the NMFS triennial survey (Figure \@ref(fig:tri-fig9), Vancouver Canadian series). The 5ABCD model was fit to the Hecate Strait Synoptic Survey, the Queen Charlotte Sound Synoptic Survey and the Hecate Strait Multispecies Assemblage Survey (Figure \@ref(fig:surv-canadian)). Detailed methods in Appendix A of @forrest2020.; 

3. Historical (1956-1995) and modern (1996+) commercial CPUE indices (Figures \@ref(fig:cpue-index-ts-hist) and \@ref(fig:cpue-index-ts-modern)). Detailed methods in Appendix B of @forrest2020.; and

4. Mean weight of Pacific Cod in the commercial bottom trawl fishery (Figures \@ref(fig:meanweight-3cd) and \@ref(fig:meanweight-5abcd)). Detailed methods in Appendix C of @forrest2020.


## Model description

*Add bare minimum here* 

Detailed methods in Appendix D of @forrest2020.

## Model scenarios

@forrest2013 and @forrest2020 used a model-averaging approach to construct decision tables based on combined posterior samples from several different sensitivity cases. This was to address some of the key irresolvable uncertainties associated with the stock assessment. Other stock assessments to use a model-averaged approach are Pacific Hake [@stewart2011], Pacific Halibut [@stewart2016], BC Shortspine Thornyhead [@starr2017] and BC Walleye Pollock [@starr2018]).

In this update, we used the same model scenarios for model-averaging (updated with data to 2019) as those that were agreed upon for the 2018 assessment (@dfo2019).

### AREA 3CD

For Area 3CD, the scenarios (Sc) included in the model-averaging set were:

• Sc 1a Reference model.

• Sc 2d Set the mean of the prior probability distribution for synoptic survey ln(q) = ln(1.0).

• Sc 2e Increase the standard deviation (SD) for synoptic survey ln(q) to 0.6.

• Sc 3a Set the parameters of the prior probability distribution for ln(M) to mean = ln(0.4), SD = 0.1.

• Sc 5a Set knife-edged age at recruitment = 3 years.

• Sc 6b Reduce the overall observation term $\sigma_O$ = 0.15.

• Sc 7b Reduce the SD in the likelihood for the fit to average annual mean weight $\sigma_W$ = 0.15.

### AREA 5ABCD

For Area 5ABCD, the scenarios (Sc) included in the model-averaging set were:

• Sc 1a Reference model.

• Sc 2d Set the mean of the prior probability distribution for synoptic survey ln(q) = ln(1.0) (pro-rated by depth-stratum areas of Area 5AB and 5CD).

• Sc 2e Increase the standard deviation (SD) for synoptic survey ln(q) to 0.6.

• Sc 3a Set the parameters of the prior probability distribution for ln(M) to mean = ln(0.4), SD = 0.1.

• Sc 5a Set knife-edged age at recruitment = 3 years.

• Sc 6b Reduce the overall observation error term $\sigma_O$ = 0.15.

• Sc 7b Reduce the SD in the likelihood for the fit to average annual mean weight $\sigma_W$ = 0.15.

See @forrest2020 and @dfo2019 for further details.

## REFERENCE POINTS

As in the 2018 assessment [@dfo2019], historical reference points were used to assess stock status, where

1. $USR$ (Upper Stock Reference) is the historical mean of the biomass estimates from 1956--2004.

2. $LRP$ (Limit Reference Point) is the lowest estimated biomass agreed upon as an undesirable state to be avoided. For Area 5ABCD this is the estimated biomass in 2000. For Area 3CD it is the estimated biomass in 1986.

3. $LRR$ (Limit Removal Rate) is the average fishing mortality rate from 1956--2004.


# RESULTS {#sec:summary-results}

We begin with a summary set of results for Area 3CD, followed by summary results for Area 5CD. 
<!--A more complete set of tables and figures is provided in Sections \@ref(sec:tables) and \@ref(sec:figures). 
However, we do not discuss these in detail.-->


*TODO: Add some summary info on the figs and tables*

## Area 3CD

For both areas, the joint posterior distribution for each model was numerically approximated using the Markov Chain Monte Carlo (MCMC) routines built into AD Model Builder (Metropolis-Hastings algorithm) [@fournier2012]. 
Posterior samples were drawn every 1,000 iterations from a chain of length 2 million, resulting in 2,000 posterior samples (the first 1,000 samples were dropped to allow for sufficient burn-in).

Model fits to the catch, indices and mean weight data are shown in Figures \@ref(fig:summary-fig-base-catch-fit-3cd), \@ref(fig:summary-fig-base-index-fits-3cd) and \@ref(fig:summary-fig-base-mean-weight-3cd), respectively.

Posterior estimated biomass from the reference case model is shown in Figure \@ref(fig:summary-fig-base-biomass-3cd) .
Posterior estimated biomass from the seven models used for model-averaging is shown in Figure \@ref(fig:summary-fig-model-average-biomass-comp-3cd).
Combined average biomass for all seven models is shown in Figure \@ref(fig:summary-fig-model-average-biomass-3cd).
Recent average biomass from the seven averaged models with a one year projection under four alternative catch levels is shown in Figure \@ref(fig:summary-fig-model-average-biomass-3cd-proj).

The model-averaged decision table for Area 3CD, based on a one year projection over a range of 2020 catch levels, suggests that under a 2020 catch of 500 tonnes (the 2018/19 TAC), there is a 9% probability that biomass in 2021 will be below the LRP (Table \@ref(tab:summary-tab-decision-avg-3cd)).
However, assuming the 2020 catch is of a similar magnitude to the 2018 and 2019 catches (23 and 43 tonnes, respectively), the probability of the 2021 biomass being below the LRP is between 5% and 6% (Table \@ref(tab:summary-tab-decision-avg-3cd)).
The 2021 biomass is projected to be in the Cautious Zone (below the USR) with greater than 99% probability under all 2020 catch scenarios tested, including zero catch.

Median estimated fishing mortality in 2019 was estimated to be 0.01 y^-1^ (Table \@ref(tab:tab-ref-points-table-avg-3cd)). 

```{r summary-fig-base-catch-fit-3cd, fig.cap="MPD fit to the catch data for Area 3CD reference model."}
catch.fit.plot(base.model.3cd, every = 5, last.yr = 2015)
```


```{r summary-fig-base-index-fits-3cd, fig.cap="MPD fits to observed indices of abundance (points) for the Area 3CD reference model from: (a) the West Coast Vancouver Island Synoptic Survey, (b) the Commercial CPUE pre-1996, (c) the Commercial CPUE post-1995, and (d) the NMFS Triennial Survey (Canadian portion)."}
plot_grid(i.plot(base.model.3cd, base.model.3cd.name, 1, every = 5),
          i.plot(base.model.3cd, base.model.3cd.name, 2, every = 5)
            + ylab("Commercial CPUE (kg/hour)"),
          i.plot(base.model.3cd, base.model.3cd.name, 3, every = 5)
            + ylab("Commercial CPUE (kg/hour)"),
          i.plot(base.model.3cd, base.model.3cd.name, 4, every = 5),
          nrow = 2,
          ncol = 2,
          labels = c("(a)", "(b)", "(c)", "(d)"),
          label_x = c(0.15, 0.13, 0.13, 0.2))
```


```{r summary-fig-base-mean-weight-3cd, fig.cap="MPD fit to the mean weight data for Area 3CD reference model."}
plot_grid(mw.plot(base.model.3cd[[1]], cv = 0.2, every = 5, last.yr = 2015),
          mw.compare.plot(base.model.3cd[[1]]),
          nrow = 1,
          ncol = 2)
```

```{r summary-fig-base-biomass-3cd, fig.cap="Posterior estimated biomass for the Reference Model, Area 3CD. The green dashed line shows the median Upper Stock Reference (USR) which is the mean biomass estimate for the years 1956--2004. The red dashed line shows the median Limit Reference Point (LRP) which is the lowest estimated biomass agreed to be an undesirable state to avoid, in this case it is the biomass estimate for 1986."}
b.plot(base.model.3cd,
       base.model.3cd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(1986, 1986),
       usr = c(1956, 2004))
```

```{r summary-fig-model-average-biomass-comp-3cd, fig.cap="Posterior estimates of biomass for the model-averaged set for Area 3CD. The green dashed line shows the median Upper Stock Reference (USR) which is the mean biomass estimate for the years 1956--2004. The red dashed line shows the median Limit Reference Point (LRP) which is the lowest estimated biomass agreed to be an undesirable state to avoid, in this case it is the biomass estimate for 1986."}
b.plot(desc.models.3cd,
       desc.models.3cd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(1986, 1986),
       usr = c(1956, 2004))
```

\clearpage


```{r summary-fig-model-average-biomass-3cd, fig.cap="Combined posterior biomass for the model-averaged set for Area 3CD.  The green dashed line shows the median Upper Stock Reference (USR) which is the mean biomass estimate for the years 1956--2004. The red dashed line shows the median Limit Reference Point (LRP) which is the lowest estimated biomass agreed to be an undesirable state to avoid, in this case it is the biomass estimate for 1986."}
b.plot(avg.model.3cd,
       base.model.3cd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(1986, 1986),
       usr = c(1956, 2004))
```

\clearpage

```{r summary-fig-model-average-biomass-3cd-proj, fig.cap="Combined posterior estimates of biomass for the model-averaged set for Area 3CD with projections (to the end of 2019).  The upper horizontal green dashed line shows the median Upper Stock Reference (USR) which is the mean biomass estimate for the years 1956--2004. The lower horizontal red dashed line shows the median Limit Reference Point (LRP) which is the lowest estimated biomass agreed to be an undesirable state to avoid, in this case it is the biomass estimate for 2000. The coloured regions to the right of the vertical line represent projections based on various TACs. The line represents the posterior median and the shaded region represents the 95\\% credible interval.For clarity, years before 2010 are removed."}
b.plot(avg.model.3cd,
       base.model.3cd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(1986, 1986),
       usr = c(1956, 2004),
       proj_columns = c("B2020", "B2021"),
       tac_vector = c(0, 500, 1000, 1500),
       year_range = c(2010, 2021),
       ylim = c(0, 50000),
       x.every = 2)
```


```{r summary-fig-base-f-3cd, fig.cap="Fishing mortality for the Reference Model, Area 3CD."}
f.plot(base.model.3cd,
       base.model.3cd.name)
```

\clearpage

```{r summary-tab-decision-avg-3cd, results='asis'}
 decision.table(avg.model.3cd,
                caption = paste0("Decision table with model averaging for Area 3CD. Models averaged are: ",
                                 and.string(c(base.model.3cd.name, sens.models.name.13.sub)),
                                 "."))
```

\clearpage

## Area 5ABCD

Model fits to the catch, indices and mean weight data are shown in Figures \@ref(fig:summary-fig-base-catch-fit-5abcd), \@ref(fig:summary-fig-base-index-fits-5abcd) and \@ref(fig:summary-fig-base-mean-weight-5abcd), respectively.

Posterior estimated biomass from the reference case model is shown in Figure \@ref(fig:summary-fig-base-biomass-5abcd) .
Posterior estimated biomass from the seven models used for model-averaging is shown in Figure \@ref(fig:summary-fig-model-average-biomass-comp-5abcd).
Combined average biomass for all seven models is shown in Figure \@ref(fig:summary-fig-model-average-biomass-5abcd).
Recent average biomass from the seven averaged models with a one year projection under four alternative catch levels is shown in Figure \@ref(fig:summary-fig-model-average-biomass-5abcd-proj).

The model-averaged decision table for Area 5ABCD, based on a one year projection over a range of 2020 catch levels, suggests that under a 2020 catch of 950 tonnes (the 2018/19 TAC), there is less than 1% probability that biomass in 2021 will be below the LRP (Table \@ref(tab:summary-tab-decision-avg-5abcd)).
Assuming the 2020 catch is of a similar magnitude to the 2018 and 2019 catches (254 and 450 tonnes, respectively), the probability of the 2021 biomass being below the LRP is also less than 1% (Table \@ref(tab:summary-tab-decision-avg-5abcd)).
However, the 2021 biomass is projected to be in the Cautious Zone (below the USR) with greater than 99% probability under all 2020 catch scenarios tested, including zero catch.

Median estimated fishing mortality in 2019 was estimated to be 0.03 y^-1^ (Table \@ref(tab:tab-ref-points-table-avg-5abcd)). 

```{r summary-fig-base-catch-fit-5abcd, fig.cap="MPD fit to the catch data for Area 5ABCD reference model. For clarity, only MPD results are shown"}
catch.fit.plot(base.model.5abcd, every = 5, last.yr = 2015)
```


```{r summary-fig-base-index-fits-5abcd, fig.cap="MPD fits to observed indices of abundance (points) for the Area 5ABCD reference model from: (a) the Hecate Strait Assemblage survey, (b) the Queen Charlotte Sound Synoptic Survey, (c) the Hecate Strait Synoptic Survey, (d) the Commercial CPUE pre-1996, and (e) the Commercial CPUE post-1995. For clarity, only MPD results are shown"}
plot_grid(i.plot(base.model.5abcd, base.model.5abcd.name, 1, every = 5),
          i.plot(base.model.5abcd, base.model.5abcd.name, 2, every = 5),
          i.plot(base.model.5abcd, base.model.5abcd.name, 3, every = 5),
          i.plot(base.model.5abcd, base.model.5abcd.name, 4, every = 10)
            + ylab("Commercial CPUE (kg/hour)"),
          i.plot(base.model.5abcd, base.model.5abcd.name, 5, every = 5)
            + ylab("Commercial CPUE (kg/hour)"),
          nrow = 2,
          ncol = 3,
          labels = c("(a)", "(b)", "(c)", "(d)", "(e)"),
          label_x = 0.2)
```

```{r summary-fig-base-mean-weight-5abcd, fig.cap="MPD fit to the mean weight data for Area 5ABCD reference model. For clarity, only MPD results are shown"}
plot_grid(mw.plot(base.model.5abcd[[1]], cv = 0.2, every = 5, last.yr = 2015),
          mw.compare.plot(base.model.5abcd[[1]]),
          nrow = 1,
          ncol = 2)
```


```{r summary-fig-base-biomass-5abcd, fig.cap="Posterior estimated biomass for the Reference Model, Area 5ABCD.  The green dashed line shows the median Upper Stock Reference (USR) which is the mean biomass estimate for the years 1956--2004. The red dashed line shows the median Limit Reference Point (LRP) which is the lowest estimated biomass agreed to be an undesirable state to avoid, in this case it is the biomass estimate for 2000."}
b.plot(base.model.5abcd,
       base.model.5abcd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(2000, 2000),
       usr = c(1956, 2004))
```


```{r summary-fig-model-average-biomass-comp-5abcd, fig.cap="Posterior estimates of biomass for the model-averaged set for Area 5ABCD. The green dashed line shows the median Upper Stock Reference (USR) which is the mean biomass estimate for the years 1956--2004. The red dashed line shows the median Limit Reference Point (LRP) which is the lowest estimated biomass agreed to be an undesirable state to avoid, in this case it is the biomass estimate for 2000."}
b.plot(desc.models.5abcd,
       desc.models.5abcd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(2000, 2000),
       usr = c(1956, 2004))
```


```{r summary-fig-model-average-biomass-5abcd, fig.cap="Combined posterior biomass for the averaged models, Area 5ABCD. The green dashed line shows the median Upper Stock Reference (USR) which is the mean biomass estimate for the years 1956--2004. The red dashed line shows the median Limit Reference Point (LRP) which is the lowest estimated biomass agreed to be an undesirable state to avoid, in this case it is the biomass estimate for 2000."}
b.plot(avg.model.5abcd,
       base.model.5abcd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(2000, 2000),
       usr = c(1956, 2004))
```

\clearpage

```{r summary-fig-model-average-biomass-5abcd-proj, fig.cap="Combined posterior estimates of biomass for the model-averaged set for Area 5ABCD with projections (to the end of 2019).  The upper horizontal green dashed line shows the median Upper Stock Reference (USR) which is the mean biomass estimate for the years 1956--2004. The lower horizontal red dashed line shows the median Limit Reference Point (LRP) which is the lowest estimated biomass agreed to be an undesirable state to avoid, in this case it is the biomass estimate for 2000. The coloured regions to the right of the vertical line represent projections based on various TACs. The line represents the posterior median and the shaded region represents the 95\\% credible interval. For clarity, years before 2010 are removed."}
b.plot(avg.model.5abcd,
       base.model.5abcd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(2000, 2000),
       usr = c(1956, 2004),
       proj_columns = c("B2020", "B2021"),
       tac_vector = c(0, 900, 2000, 3000),
       year_range = c(2010, 2021),
       ylim = c(0, 50000),
       x.every = 2)
```

\clearpage

```{r summary-fig-base-f-5abcd, fig.cap="Fishing mortality for the Reference Model, Area 5ABCD."}
f.plot(base.model.5abcd,
       base.model.5abcd.name)
```

\clearpage


```{r summary-tab-decision-avg-5abcd, results='asis'}
 decision.table(avg.model.5abcd,
                caption = paste0("Decision table with model averaging for Area 5ABCD. Models averaged are: ",
                                 and.string(c(base.model.5abcd.name, sens.models.name.6.sub)),
                                 "."))
```

\clearpage

