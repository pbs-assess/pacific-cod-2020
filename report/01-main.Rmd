
# Context

Pacific Cod (*Gadus macrocephalus*) is a relatively short-lived, fast-growing member of the family Gadidae.
A common name in British Columbia (BC) is grey cod (or gray cod).
Pacific Cod in BC are caught almost entirely in the groundfish bottom trawl fishery, which is part of BC's integrated groundfish fishery [@dfo2017]. They are also caught in very small quantities in the groundfish longline fishery (around 0.5% of the total annual catch on average), which is also part of the integrated fishery.
Currently, the majority of the BC Pacific Cod catch is taken from Hecate Strait (HS; Area 5CD).
Commercial catches also come from Queen Charlotte Sound (QCS; Area 5AB) and the west coast of Vancouver Island (WCVI; Area 3CD). Near negligible catch is also taken from the west coast of Haida Gwaii, Area 5E ( < 0.5% of total average annual catch since 1985).

The last Pacific Cod assessment was done in 2018, providing catch advice for 2019 [@forrest2020; @dfo2019].
Separate assessments were done for stocks in Area 3CD (WCVI) and Area 5ABCD (QCS and HS combined) (Figure \@ref(fig:fig-map)).
Both stocks were assessed to be in the Cautious Zone [@dfo2009].
The assessment models were delay-difference models [@deriso1980], fit to survey indices, commercial catch-per-unit-effort (CPUE), commercial catch data and commercial annual mean weights [@forrest2015; @forrest2020].

Fishery-independent synoptic bottom trawl surveys are conducted biennially in BC, usually occurring in even-numbered years for WCVI, and odd-numbered years in QCS and HS.
However, due to the COVID-19 pandemic, the scheduled 2020 WCVI survey did not occur.
The 2018 survey index for WCVI was very low, approximately 25% of the magnitude of the 2014 and 2016 observations (Figure \@ref(fig:fig-summary-indices-3cd); Table \@ref(tab:surv-canadian-table)).
The commercial CPUE index has also decreased since 2016 (Figure \@ref(fig:fig-summary-indices-3cd)).
Catches in 2018 and 2019 in Area 3CD were also low (Table \@ref(tab:tab-catch-3cd), Figure \@ref(fig:fig-catch-3cd)).

The previous advice [@dfo2019], recommended updates be provided in years immediately following the biennial groundfish synoptic bottom trawl survey in each area (i.e., when the most recent survey index point is available).
However, given the low index of abundance in 2018 Area 3CD, coupled with the lack of updated survey information in 2020, Fisheries and Oceans Canada (DFO) Pacifc Fisheries Management Branch has requested that DFO Pacifc Science Branch assess the status of BC Pacifc cod stocks in 2020 and recommend harvest advice for 2021 to inform the development of the 2020/2021 Integrated Fisheries Management Plan.

While there was no apparent decrease in survey or CPUE indices for either Hecate Strait or Queen Charlotte Sound (Figure \@ref(fig:surv-canadian)), which survey the Area 5ABCD stock, DFO Pacifc Science Branch has taken the opportunity to update all the data streams for both Areas 3CD and 5ABCD and re-run both stock assessments to re-assess stock status in **2020** and provide catch advice for **2021**.

*TODO: currently data only up to 2019. Update to 2020, will have to pro-rate catch.*



```{r get-recent-3CD-index-data}

#CPUE
params <- list()
params$species_proper <- "Pacific Cod"
params$april1_year <- TRUE
params$area <- c("5[ABCD]+", "3[CD]+")
params$area_name <- c("5ABCD", "3CD")
params$skip_single_variable_models <- FALSE

params$era <- "modern"
source(here::here("R/cpue.R"))
dfleet_modern <- dfleet
gg_cpue_modern <- gg_cpue
cpue_pred_modern <- predictions
arith_cpue_modern <- arith_cpue

#Survey
surv.file <- here::here("data/generated/all_surveys.csv")

if(!file.exists(surv.file)){
  message("Error: Survey indices file has not been made! Please run 04-survey-indices-app.Rmd first.")
} else {
  surv_index <- readr::read_csv(here::here("data/generated/all_surveys.csv"))
}

```


```{r fig-wcvi-index-3cd, fig.cap="West Coast Vancouver Island Synoptic Survey estimates, centred by geometric mean", echo=FALSE}

g1 <- surv_index %>%  
  rename("Survey"= "Survey abbrev.", "Lower" = "Lower CI", "Upper"="Upper CI") %>%   dplyr::filter(Survey=="SYN WCVI") %>% 
  select(Survey, Year,Biomass, CV) %>%
  mutate("GeometricMean"= Biomass/exp(mean(log(Biomass)))) %>%
  mutate("LowerG" = exp(log(GeometricMean))-2*CV, "UpperG"=exp(log(GeometricMean))+2*CV) %>%   ggplot(aes(Year, GeometricMean)) + 
  geom_pointrange(aes(ymin=LowerG, ymax=UpperG))+
  theme_pbs() +
  theme(axis.title = element_blank())
#g1


```


```{r fig-cpue-index-3cd, fig.cap="Commercial CPUE estimates, centred by geometric mean", echo=FALSE}

g2 <- cpue_pred_modern %>%
  dplyr::filter(formula_version=="Full standardization", area=="3CD") %>%
  select(year, est,se_link) %>%
  mutate("GeometricMean"= est/exp(mean(log(est)))) %>%
  mutate("LowerG" = exp(log(GeometricMean))-2*se_link, "UpperG"=exp(log(GeometricMean))+2*se_link) %>% 
  ggplot(aes(year, GeometricMean)) + 
  geom_pointrange(aes(ymin=LowerG, ymax=UpperG))+
  theme_pbs() +
  theme(axis.title = element_blank())
#g2

```


```{r fig-summary-indices-3cd, fig.cap="Top: Relative index of abundance from the West Coast Vancouver Island Synoptic Survey, centred by its geometric mean. Bottom: Commercial CPUE, centred by its geometric mean", echo=FALSE}

cowplot::plot_grid(g1,g2, ncol=1,labels = c("","")) +
  draw_label("Relative index of abundance", x=  0, y=0.5, vjust= 1.5, angle=90)+
  draw_label("Year", x=  0.5, y=0, vjust= 0, angle=0)

```


```{r fig-iphc-index-3cd}
#this is not very useful but keep the code so we know how to get iphc data in future

# # Need to check which areas are included. May need to filter data first to be only 3CD,
# # then plot either series C or D (which are coastwide)
# iphc.3CD <- iphc.dat %>% 
#   filter(lat <50.7) #the border of 3D is actually 50.5 but not enough obs if that is used 
# 
# # iphc.3CD$ser_longest is series C (does not filter for > 50.6 degrees)
# glist <- gfiphc::calc_iphc_full_res(iphc.3CD) 
# 
# g <- glist$ser_longest %>% 
#   select(year, I_tBootMean, I_tBootCV) %>%
#   mutate("GeometricMean"= I_tBootMean/exp(mean(log(I_tBootMean)))) %>%
#   mutate("LowerG" = exp(log(GeometricMean))-2*I_tBootCV, "UpperG"=exp(log(GeometricMean))+2*I_tBootCV) %>% 
#   ggplot(aes(year, GeometricMean)) + 
#   geom_pointrange(aes(ymin=LowerG, ymax=UpperG))+
#   theme_pbs() +
#   ylab("IPHC FISS (centred by its geometric mean)")+
#   xlab("Year") 
# g 
#   

```

# Background

# Description of the fishery

# Analysis and response

## Data

Data were extracted from DFO databases in the same way as described in @forrest2020, with updates to 2019. The models were fit to:

1. Commercial catch data (Tables \@ref(tab:tab-catch-3cd) and \@ref(tab:tab-catch-5abcd), Figures \@ref(fig:fig-catch-3cd) and \@ref(fig:fig-catch-5abcd)); 

2. Survey indices of abundance. The 3CD model was fit to the WCVI Synoptic Survey (Figure \@ref(fig:surv-canadian)) and the NMFS triennial survey (Figure \@ref(fig:tri-fig9), Vancouver Canadian series). The 5ABCD model was fit to the Hecate Strait Synoptic Survey, the Queen Charlotte Sound Synoptic Survey and the Hecate Strait Multispecies Assemblage Survey (Figure \@ref(fig:surv-canadian)). Detailed methods in Appendix A of @forrest2020.; 

3. Historical (1956-1995) and modern (1996+) commercial CPUE indices (Figures \@ref(fig:cpue-index-ts-hist) and \@ref(fig:cpue-index-ts-modern)). Detailed methods in Appendix B of @forrest2020.; and

4. Mean weight of Pacific Cod in the commercial bottom trawl fishery (Figures \@ref(fig:meanweight-3cd) and \@ref(fig:meanweight-5abcd)). Detailed methods in Appendix C of @forrest2020.


## Stock assessment model

**TODO: Add a bare minimum description of the methods, referring to previous assessment**

## Model scenarios

@forrest2015 and @forrest2020 used a model-averaging approach to construct decision tables based on combined posterior samples from several different sensitivity cases. This was to address some of the key irresolvable uncertainties associated with the stock assessment. Other stock assessments to use a model-averaged approach are Pacific Hake [@stewart2011], Pacific Halibut [@stewart2016], BC Shortspine Thornyhead [@starr2017] and BC Walleye Pollock [@starr2018]).

In this update, we used the same model scenarios for model-averaging (updated with data to 2019) as those that were agreed upon for the 2018 assessment (@dfo2019).

### Area 3CD

For Area 3CD, the scenarios (Sc) included in the model-averaging set were:

• Sc 1a Reference model.

• Sc 2d Set the mean of the prior probability distribution for synoptic survey ln(q) = ln(1.0).

• Sc 2e Increase the standard deviation (SD) for synoptic survey ln(q) to 0.6.

• Sc 3a Set the parameters of the prior probability distribution for ln(M) to mean = ln(0.4), SD = 0.1.

• Sc 5a Set knife-edged age at recruitment = 3 years.

• Sc 6b Reduce the overall observation term $\sigma_O$ = 0.15.

• Sc 7b Reduce the SD in the likelihood for the fit to average annual mean weight $\sigma_W$ = 0.15.

### Area 5ABCD

For Area 5ABCD, the scenarios (Sc) included in the model-averaging set were:

• Sc 1a Reference model.

• Sc 2d Set the mean of the prior probability distribution for synoptic survey ln(q) = ln(1.0) (pro-rated by depth-stratum areas of Area 5AB and 5CD).

• Sc 2e Increase the standard deviation (SD) for synoptic survey ln(q) to 0.6.

• Sc 3a Set the parameters of the prior probability distribution for ln(M) to mean = ln(0.4), SD = 0.1.

• Sc 5a Set knife-edged age at recruitment = 3 years.

• Sc 6b Reduce the overall observation error term $\sigma_O$ = 0.15.

• Sc 7b Reduce the SD in the likelihood for the fit to average annual mean weight $\sigma_W$ = 0.15.

See @forrest2020 and @dfo2019 for further details.

## Reference points

As in the 2018 assessment [@dfo2019], historical reference points were used to assess stock status, where

1. $USR$ (Upper Stock Reference) is the historical mean of the biomass estimates from 1956--2004.

2. $LRP$ (Limit Reference Point) is the lowest estimated biomass agreed upon as an undesirable state to be avoided. For Area 5ABCD this is the estimated biomass in 2000. For Area 3CD it is the estimated biomass in 1986.

3. $LRR$ (Limit Removal Rate) is the average fishing mortality rate from 1956--2004.


# Assessment results {#sec:summary-results}

We begin with a summary set of results for Area 3CD, followed by summary results for Area 5CD. 
<!--A more complete set of tables and figures is provided in Sections \@ref(sec:tables) and \@ref(sec:figures). 
However, we do not discuss these in detail.-->


*TODO: Add some summary info on the figs and tables*

## Reference model results

### Area 3CD

For both areas, the joint posterior distribution for each model was numerically approximated using the Markov Chain Monte Carlo (MCMC) routines built into AD Model Builder (Metropolis-Hastings algorithm) [@fournier2012]. 
Posterior samples were drawn every 1,000 iterations from a chain of length 2 million, resulting in 2,000 posterior samples (the first 1,000 samples were dropped to allow for sufficient burn-in).

Model fits to the catch, indices and mean weight data are shown in Figures \@ref(fig:summary-fig-base-catch-fit-3cd), \@ref(fig:summary-fig-base-index-fits-3cd) and \@ref(fig:summary-fig-base-mean-weight-3cd), respectively.

Posterior estimated biomass from the reference case model is shown in Figure \@ref(fig:summary-fig-base-biomass-3cd) .
Posterior estimated biomass from the seven models used for model-averaging is shown in Figure \@ref(fig:summary-fig-model-average-biomass-comp-3cd).
Combined average biomass for all seven models is shown in Figure \@ref(fig:summary-fig-model-average-biomass-3cd).
Recent average biomass from the seven averaged models with a one year projection under four alternative catch levels is shown in Figure \@ref(fig:summary-fig-model-average-biomass-3cd-proj).

The model-averaged decision table for Area 3CD, based on a one year projection over a range of 2020 catch levels, suggests that under a 2020 catch of 500 tonnes (the 2018/19 TAC), there is a 9% probability that biomass in 2021 will be below the LRP (Table \@ref(tab:summary-tab-decision-avg-3cd)).
However, assuming the 2020 catch is of a similar magnitude to the 2018 and 2019 catches (23 and 43 tonnes, respectively), the probability of the 2021 biomass being below the LRP is between 5% and 6% (Table \@ref(tab:summary-tab-decision-avg-3cd)).
The 2021 biomass is projected to be in the Cautious Zone (below the USR) with greater than 99% probability under all 2020 catch scenarios tested, including zero catch.

Median estimated fishing mortality in 2019 was estimated to be 0.01 y^-1^ (Table \@ref(tab:tab-ref-points-table-avg-3cd)). 

### Area 5ABCD

Model fits to the catch, indices and mean weight data are shown in Figures \@ref(fig:summary-fig-base-catch-fit-5abcd), \@ref(fig:summary-fig-base-index-fits-5abcd) and \@ref(fig:summary-fig-base-mean-weight-5abcd), respectively.

Posterior estimated biomass from the reference case model is shown in Figure \@ref(fig:summary-fig-base-biomass-5abcd) .
Posterior estimated biomass from the seven models used for model-averaging is shown in Figure \@ref(fig:summary-fig-model-average-biomass-comp-5abcd).
Combined average biomass for all seven models is shown in Figure \@ref(fig:summary-fig-model-average-biomass-5abcd).
Recent average biomass from the seven averaged models with a one year projection under four alternative catch levels is shown in Figure \@ref(fig:summary-fig-model-average-biomass-5abcd-proj).

The model-averaged decision table for Area 5ABCD, based on a one year projection over a range of 2020 catch levels, suggests that under a 2020 catch of 950 tonnes (the 2018/19 TAC), there is less than 1% probability that biomass in 2021 will be below the LRP (Table \@ref(tab:summary-tab-decision-avg-5abcd)).
Assuming the 2020 catch is of a similar magnitude to the 2018 and 2019 catches (254 and 450 tonnes, respectively), the probability of the 2021 biomass being below the LRP is also less than 1% (Table \@ref(tab:summary-tab-decision-avg-5abcd)).
However, the 2021 biomass is projected to be in the Cautious Zone (below the USR) with greater than 99% probability under all 2020 catch scenarios tested, including zero catch.

Median estimated fishing mortality in 2019 was estimated to be 0.03 y^-1^ (Table \@ref(tab:tab-ref-points-table-avg-5abcd)). 


## Model-averaged decision tables {#sec:catch-advice}

### Area 3CD


### Area 5ABCD


# Conclusions

\clearpage
