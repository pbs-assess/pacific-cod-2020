\clearpage

`r if(knitr:::is_latex_output()) '\\Appendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

\vspace{50pt}

# Data

## Catch

### Area 3CD

```{r tab-catch-3cd}
catch.table(catch.3,
            catch.3.discards,
            area = "3CD",
 cap = paste0("Reported catch (mt) of Pacific Cod in Area 3CD ",
              "by Canada and the USA, ",
              min(catch.3$year), "--", max(catch.3$year),
              ". The reported discards for the period ", min(catch.3$year),
              "--1995 are ",
              "unrepresentative of true discarding because the estimates were taken ",
              "from logbooks. Discard estimates since 1996 are based on at-sea ",
              "observations and are considered to be more representative of true discarding."), french=french)
```

\clearpage

```{r fig-catch-3cd, fig.cap="Catch for Area 3CD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.3, french=french)
```

```{r fig-discards-3cd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 3CD."}
discards.plot(catch.3, french=french)
```

<!--

```{r fig-catch-3cd-gear, fig.cap="Canadian catch for Area 3CD by gear. Catch includes at-sea releases."}
make.catches.plot.gear(catch.3.gear, french=french)
```

-->

```{r fig-catch-3cd-gear-recent, fig.cap="Canadian catch for Area 3CD by gear since 1996. Catch includes at-sea releases."}
catch.3.gear.recent <- catch.3.gear %>% dplyr::filter(year>1995) %>%                 dplyr::filter(year<2020)
make.catches.plot.gear(catch.3.gear.recent, french=french)
```

<!--

```{r fig-catch-3cd-gear-vessel, fig.cap="Canadian catch for Area 3CD by vessel, showing catch from freezer trawlers. Catch includes at-sea releases."}
# This plot is for exploring, do not publish
 freezer <- c("NORTHERN ALLIANCE", "OSPREY NO 1", "VIKING ENTERPRISE", "RAW SPIRIT", "VIKING ALLIANCE")
 catch.3.gear.vessel.freezer <- catch.3.gear.vessel %>% 
         filter(vessel_name %in% freezer)
 
make.catches.plot.vessel(catch.3.gear.vessel.freezer)
```

-->

\clearpage

### Area 5ABCD

```{r tab-catch-5abcd}
catch.table(catch.5,
            catch.5.discards,
            area = "5ABCD",
 cap = paste0("Reported catch (mt) of Pacific Cod in Area 5ABCD ",
              "by Canada and the USA, ",
              min(catch.5$year), "--", max(catch.5$year),
              ". The reported discards for the period ", min(catch.5$year),
              "--1995 are ",
              "unrepresentative of true discarding because the estimates were taken ",
              "from logbooks. Discard estimates since 1996 are based on at-sea ",
              "observations and are considered to be more representative of true discarding."),      french=french)

```

\clearpage

```{r fig-catch-5abcd, fig.cap="Catch for Area 5ABCD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5, french=french)
```


```{r fig-discards-5abcd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5ABCD."}
discards.plot(catch.5, french=french)
```

<!--

```{r fig-catch-5ab, fig.cap="Catch for Area 5AB. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5ab, french=french)
```

```{r fig-discards-5ab, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5AB."}
discards.plot(catch.5ab, french=french)
```

```{r fig-catch-5cd, fig.cap="Catch for Area 5CD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5cd, french=french)
```

```{r fig-discards-5cd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5CD."}
discards.plot(catch.5cd, french=french)
```

-->

\clearpage

## FISHERY-INDEPENDENT INDICES OF ABUNDANCE {#app:data-summary}

### CANADIAN SURVEYS

All survey indices were calculated using a swept area analysis, documented in Appendix A of @forrest2020.

*TODO: add brief summary text -- do we need the descriptions? NO*

#### HECATE STRAIT ASSEMBLAGE SURVEY

A series of multi-species groundfish bottom trawl surveys was conducted in
Hecate Strait in May-June of 1984, 1987, 1989, 1991, 1993, 1995, 1996, 1998,
2000, 2002, and 2003 @westrheim1984, @fargo1984, @fargo1988, @wilson1991,
@hand1994, @workman1996, @workman1997, @choromanski2002).
The results up to 2000 were reported in the 2001
assessment [@sinclair2001] and results from 2002 and 2003 were presented in the
2005 assessment [@sinclair2005].

#### HECATE STRAIT SYNOPTIC SURVEY

The Hecate Strait synoptic groundfish bottom trawl survey is part of
a coordinated set of long-term surveys that together cover the continental
shelf and upper slope of most of the BC coast. 
The Hecate Strait synoptic survey has been
conducted during May-June, in odd years since 2005. 
All the synoptic surveys
follow a random depth stratified design. The survey area is divided into 2 km
by 2 km blocks and each block is assigned to one of four depth strata based on
the average bottom depth in the block. 
The four depth strata for the Hecate
Strait survey are 10--70m, 70--130m, 130--220m, and 220--500m. Each year blocks
are randomly selected within each depth strata. 

#### QUEEN CHARLOTTE SOUND SYNOPTIC SURVEY

The Queen Charlotte Sound (QCS) synoptic groundfish bottom trawl survey has
been conducted in July--August in 2003, 2004, and in odd years since 2005.
The four depth strata for the QCS survey are 50--125m, 125--200m, 200--330m, and 330--500 m. 
Each year blocks are randomly selected within each depth strata. In addition, for the purposes of
allocating blocks, the QCS survey is divided into northern and southern spatial
strata.

#### WEST COAST VANCOUVER ISLAND SYNOPTIC SURVEY

The West Coast Vancouver Island synoptic bottom trawl survey was first
conducted in 2004 and is conducted in alternating (even-numbered) years on
a chartered commercial trawler.
The survey area is off the west coast of Vancouver Island from approximately 49
$^\circ$  12$^\prime$ to 50 $^\circ$ 36$^\prime$ North latitude and
approximately 124 $^\circ$  48$^\prime$ to 128 $^\circ$  30$^\prime$ West
longitude.
The southern boundary is contiguous with the Canada/U.S. boundary.
The survey has a single aerial stratum in Pacific Fishery Management Area
regions 3C and 3D separated into four depth strata: 50--125m; 125--200m;
200--330m; and 330--500m. Approximately 150 to 180 4 km^2^ blocks are selected
randomly among the four depth strata when conducting each survey.

\clearpage


```{r surv-canadian-table, results='asis'}
dplyr::filter(dat$survey_index, survey_abbrev %in%
  c("SYN QCS", "SYN WCVI", "SYN HS", "OTHER HS MSA")) %>%
  dplyr::select(survey_abbrev, year, biomass, re, lowerci, upperci, num_sets, num_pos_sets) %>%
  dplyr::mutate(lowerci = round(lowerci/1000, 1), upperci = round(upperci/1000, 1),
    biomass = round(biomass/1000, 1), re = round(re, 2)) %>%
  dplyr::rename(`Survey abbrev.` = survey_abbrev, Year = year, Biomass = biomass,
    CV = re, `Lower CI` = lowerci, `Upper CI` = upperci, Sets = num_sets, `Positive sets` = num_pos_sets) %>%
  dplyr::arrange(`Survey abbrev.`, Year) %>%
  knitr::kable(caption = "Pacific Cod survey data for Canadian trawl surveys in metric tons (without accounting for survey catchability). Positive sets refers to the number of trawl sets that caught Pacific Cod.", booktabs = TRUE, linesep = "", 
    format = "pandoc")
```

\clearpage

```{r surv-canadian, fig.cap="Pacific Cod survey data for Canadian trawl surveys. Shown is relative biomass and associated lower and upper confidence intervals. Positive sets refers to the number of trawl sets that caught Pacific Cod."}
gfplot::tidy_survey_index(dat$survey_index,
  survey = c("SYN QCS", "SYN WCVI", "SYN HS", "OTHER HS MSA")) %>%
  plot_survey_index()
```

\clearpage

#### NMFS TRIENNIAL SURVEY (IN CANADIAN WATERS)

A relative abundance index was developed for Area 3CD from data from the
National Marine Fisheries Service (NMFS) Triennial survey operated off the
lower half of Vancouver Island.
See Appendix A of @forrest2018 for complete details.

```{r tri-fig9, fig.cap="Biomass estimates for three series of Pacific Cod in the INPFC Vancouver region (total region, Canadian waters only, US waters only) with 95\\% error bars estimated from 1000 bootstraps."}
insert_paul_figure <- function(n) {
  knitr::include_graphics(here::here("report", "paul-figs", paste0("paul", n, ".png")), dpi = NA)
}

insert_paul_figure(9)
```


\clearpage

## COMMERCIAL CPUE

We used the same approach for standardizing the historical (1956:1995) and modern (1996+) commercial CPUE indices as in the previous assessment [@forrest2020], with data added for 2018 and 2019.

*TODO: add brief summary text*

```{r cpue-funcs}
source(here::here('R/cpue-functions.R'))
```

```{r cpue-params}
params <- list()
params$species_proper <- "Pacific Cod"
params$april1_year <- TRUE
params$area <- c("5[ABCD]+", "3[CD]+")
params$area_name <- c("5ABCD", "3CD")
params$skip_single_variable_models <- FALSE
```

```{r cpue-run-historic, message=FALSE, warning=FALSE, results='hide'}
params$era <- "historic"
source(here::here("R/cpue.R"))
dfleet_hist <- dfleet
gg_cpue_hist <- gg_cpue
cpue_pred_hist <- predictions
arith_cpue_hist <- arith_cpue
m_historic <- readRDS(here::here("data/generated/cpue-models-pcod-historic.rds"))
```

```{r cpue-run-modern, message=FALSE, warning=FALSE, results='hide'}
params$era <- "modern"
source(here::here("R/cpue.R"))
dfleet_modern <- dfleet
gg_cpue_modern <- gg_cpue
cpue_pred_modern <- predictions
arith_cpue_modern <- arith_cpue
m_modern <- readRDS(here::here("data/generated/cpue-models-pcod-modern.rds"))
```

```{r cpue-save}
readr::write_csv(cpue_pred_modern, here::here("data/generated/cpue-predictions-modern.csv"))
readr::write_csv(cpue_pred_hist, here::here("data/generated/cpue-predictions-historical.csv"))
```

```{r cpue-index-ts-hist, fig.asp=1.15, fig.cap="Commercial trawl CPUE standardization models. Throughout, the black line and shaded region indicate a CPUE index with only a year predictor. The coloured line and shaded ribbons indicate indices that have been standardized by one or more predictors. The first three rows illustrate standardization models that include a single predictor listed on the right. The second last row illustrates a standardization model that includes all the predictors in one model. The last row illustrates a standardization model that includes all the predictors plus locality-by-year (space-time) random effects. Locality and locality-vessel interactions are fit as random effects and all other variables are fit as fixed effects."}
make_cpue_ts_dat(cpue_pred_hist) %>% make_cpue_ts_plot() +
  ggtitle("1956-1995 CPUE") +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
```

(ref:caption-cpue-index-ts-modern) Same as Figure \@ref(fig:cpue-index-ts-hist) but for the 1996 to 2017 data. Locality, vessel, and locality-vessel interactions are fit as random effects and all other variables are fit as fixed effects.

```{r cpue-index-ts-modern, fig.asp=1.55, fig.cap="(ref:caption-cpue-index-ts-modern)", out.width="5.2in", fig.width=6.5}
make_cpue_ts_dat(cpue_pred_modern) %>% make_cpue_ts_plot() +
  ggtitle("1996+ CPUE") +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
```

\clearpage

## ANNUAL MEAN WEIGHT IN COMMERCIAL CATCH

*TODO: Add text here*

```{r}
mw5ABCD <- read_csv(here::here("data/results/AnnualMeanWeight_5ABCD.csv"))
mw3CD <- read_csv(here::here("data/results/AnnualMeanWeight_3CD.csv"))
```


### AREA 3CD

```{r meanweight-3cd, fig.cap="Mean weight (kg) in the commercial catch for Area 3CD", out.width="5.2in", fig.width=6.5}

df <- mw3CD
ggplot(data=df, aes(x=year,y=mean_weight, group=1)) +
  geom_line(lwd=1, colour=2) +
  ylim(0,1.1*max(df$mean_weight)) +
  theme(plot.title=element_text(size=14,face="bold",hjust=0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  scale_x_continuous(breaks=seq(min(df$year),max(df$year),by=5)) +
  labs(x= "Fishing Year", y = "Annual Mean Weight (Kg)", title="Area 3CD")
```

\clearpage

### AREA 5ABCD

```{r meanweight-5abcd, fig.cap="Mean weight (kg) in the commercial catch for Area 5ABCD", out.width="5.2in", fig.width=6.5}
df <- mw5ABCD
ggplot(data=df, aes(x=year,y=mean_weight, group=1)) +
  geom_line(lwd=1, colour=2) +
  ylim(0,1.1*max(df$mean_weight)) +
  theme(plot.title=element_text(size=14,face="bold",hjust=0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  scale_x_continuous(breaks=seq(min(df$year),max(df$year),by=5)) +
  labs(x= "Fishing Year", y = "Annual Mean Weight (Kg)", title="Area 5ABCD")
```

