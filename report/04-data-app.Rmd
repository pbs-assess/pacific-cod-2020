\clearpage

`r if(knitr:::is_latex_output()) '\\Appendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

\vspace{50pt}

# Data {#app:data-appendix}

## Commercial catch

Commercial catch data were extracted from three different databases held by DFO: *GFCatch* (Canadian trawl landings, 1954--1995); *PacHarvTrawl* (Canadian trawl landings, 1996 to March 31, 2007); and *GFFOS* (Canadian trawl landings, April 1, 2007 to 2020).
Catch data prior to 1981 include catch by US vessels [@forrest2015; @forrest2020].
Fishing years are defined as beginning on April 1 for all years, and are referenced by starting year, e.g., fishing year 1957 runs from April 1, 1957 to March 31, 1958 [see @forrest2020].

At the time of the assessment, the 2020 fishing year was incomplete.
In order to provide projections for the 2021 fishing season, the 2020 catch was extrapolated in each area, using the three year average proportion of catch taken by September 30 (representing the end of the second quarter of the 2020 fishing year).
This proportion was used to extrapolate from the catch at September 30, 2020 to a total estimated catch for the 2020 fishing year (Tables \@ref(tab:tab-catch-3cd) and \@ref(tab:tab-catch-5abcd)).

## Fishery-independent indices of abundance {#app:data-summary}

### Canadian bottom trawl surveys

The assessment models were fit to several relative indices of abundance for Pacific Cod (Table \@ref(tab:surv-canadian-table) and Figure (fig:surv-canadian)).
All survey indices were calculated using a swept area analysis, documented in Appendix A of @forrest2020.

Abundance in Area 3CD (\@ref(fig:fig-map)) is indexed by the West Coast Vancouver Island Synoptic Survey.
The survey was first conducted in 2004 and is conducted in alternating (even-numbered) years.
Due to the COVID-19 pandemic there was no survey in 2020.

Abundance in Area 5AB (\@ref(fig:fig-map)) is indexed by the Queen Charlotte Sound Synoptic Survey.
The survey was first conducted in 2003 and 2004, and then in odd years since 2005.
Abundance in Area 5CD (\@ref(fig:fig-map)) was indexed by the Hecate Strait Multispecies Assemblage Survey in 1984, 1987, 1989, 1991, 1993, 1995, 1996, 1998, 2000, 2002, and 2003.
Since 2005, it has been indexed in odd-numbered years by the Hecate Strait Synoptic Survey.

Details on spatial extent and depth strata of all surveys are also provided in Appendix A of @forrest2020.

### NMFS Triennial Survey (in Canadian waters)

An additional relative abundance index for Area 3CD was developed using data from the
National Marine Fisheries Service (NMFS) Triennial survey, which operated off the lower half of West Coast Vancouver Island between 1980 and 2001 (Figure \@ref(fig:tri-fig9)).
See Appendix A of @forrest2018 for complete details.

## Commercial CPUE

The assessment models were fit to standardized commercial CPUE indices for the historical (1956:1995) and modern (1996:2019) periods (full standardization models in Figures  \@ref(fig:cpue-index-ts-hist) and \@ref(fig:cpue-index-ts-modern)).
The indices were developed using a new Tweedie standardized generalized linear mixed model (GLMM) described in detail in Appendix B of @forrest2020.
The full standardization historical period GLMMs included predictors for depth, locality, month, and a locality-year interaction (Figure \@ref(fig:cpue-index-ts-hist)).
The full standardization modern period GLMMs included predictors for depth, latitude, locality, month, vessel and a locality-year interaction (Figure \@ref(fig:cpue-index-ts-modern)).

## Annual mean weight in commercial catch

The assessment models were fit to annual mean weight data, where the mean weight in the commercial catch for each sequential fishing quarter was weighted by the commercial catch in that quarter [see Appendix C of @forrest2020 for details].
Mean weight data were available from 1956 to 2019.
In the absence of commercial biological samples for 2020, we assumed the same annual mean weight in 2020 as for 2019.

\clearpage

```{r tab-catch-3cd}
catch.table(catch.3,
            catch.3.discards,
            area = "3CD",
 cap = paste0("Reported catch (mt) of Pacific Cod in Area 3CD ",
              "by Canada and the USA, ",
              min(catch.3$year), "--", max(catch.3$year),
              ". The reported discards for the period ", min(catch.3$year),
              "--1995 are ",
              "unrepresentative of true discarding because the estimates were taken ",
              "from logbooks. Discard estimates since 1996 are based on at-sea ",
              "observations and are considered to be more representative of true discarding."), french=french)
```

<!--

```{r fig-discards-3cd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 3CD."}
discards.plot(catch.3, french=french)
```


```{r fig-catch-3cd-gear, fig.cap="Canadian catch for Area 3CD by gear. Catch includes at-sea releases."}
make.catches.plot.gear(catch.3.gear, french=french)
```

```{r fig-catch-3cd-gear-recent, fig.cap="Canadian catch for Area 3CD by gear since 1996. Catch includes at-sea releases."}
catch.3.gear.recent <- catch.3.gear %>% dplyr::filter(year>1995) %>%                 dplyr::filter(year<2021)
make.catches.plot.gear(catch.3.gear.recent, french=french)
```


```{r fig-catch-3cd-gear-vessel, fig.cap="Canadian catch for Area 3CD by vessel, showing catch from freezer trawlers. Catch includes at-sea releases."}
# This plot is for exploring, do not publish
 freezer <- c("NORTHERN ALLIANCE", "OSPREY NO 1", "VIKING ENTERPRISE", "RAW SPIRIT", "VIKING ALLIANCE")
 catch.3.gear.vessel.freezer <- catch.3.gear.vessel %>% 
         filter(vessel_name %in% freezer)
 
make.catches.plot.vessel(catch.3.gear.vessel.freezer)
```

-->

\clearpage

```{r tab-catch-5abcd}
catch.table(catch.5,
            catch.5.discards,
            area = "5ABCD",
 cap = paste0("Reported catch (mt) of Pacific Cod in Area 5ABCD ",
              "by Canada and the USA, ",
              min(catch.5$year), "--", max(catch.5$year),
              ". The reported discards for the period ", min(catch.5$year),
              "--1995 are ",
              "unrepresentative of true discarding because the estimates were taken ",
              "from logbooks. Discard estimates since 1996 are based on at-sea ",
              "observations and are considered to be more representative of true discarding."),      french=french)

```

<!--

```{r fig-discards-5abcd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5ABCD."}
discards.plot(catch.5, french=french)
```

```{r fig-catch-5ab, fig.cap="Catch for Area 5AB. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5ab, french=french)
```

```{r fig-discards-5ab, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5AB."}
discards.plot(catch.5ab, french=french)
```

```{r fig-catch-5cd, fig.cap="Catch for Area 5CD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5cd, french=french)
```

```{r fig-discards-5cd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5CD."}
discards.plot(catch.5cd, french=french)
```

-->

\clearpage

```{r surv-canadian-table, results='asis'}
dplyr::filter(dat$survey_index, survey_abbrev %in%
  c("SYN QCS", "SYN WCVI", "SYN HS", "OTHER HS MSA")) %>%
  dplyr::select(survey_abbrev, year, biomass, re, lowerci, upperci, num_sets, num_pos_sets) %>%
  dplyr::mutate(lowerci = round(lowerci/1000, 1), upperci = round(upperci/1000, 1),
    biomass = round(biomass/1000, 1), re = round(re, 2)) %>%
  dplyr::rename(`Survey abbrev.` = survey_abbrev, Year = year, Biomass = biomass,
    CV = re, `Lower CI` = lowerci, `Upper CI` = upperci, Sets = num_sets, `Positive sets` = num_pos_sets) %>%
  dplyr::arrange(`Survey abbrev.`, Year) %>%
  knitr::kable(caption = "Pacific Cod survey data for Canadian trawl surveys in metric tons (without accounting for survey catchability). Positive sets refers to the number of trawl sets that caught Pacific Cod. OTHER HS MSA = Hecate Strait Multispecies Assemblage survey; SYN HS = Hecate Strait synoptic bottom trawl survey; SYN QCS = Queen Charlotte Sound synoptic bottom trawl survey; SYN WCVI = West Coast Vancouver Island synoptic bottom trawl survey.", booktabs = TRUE, linesep = "", 
    format = "pandoc")
```

\clearpage

```{r fig-catch-3cd, fig.cap="Catch for Area 3CD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.3, french=french)
```

```{r fig-catch-5abcd, fig.cap="Catch for Area 5ABCD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5, french=french)
```

```{r surv-canadian, fig.cap="Pacific Cod survey data for Canadian trawl surveys. Shown is relative biomass and associated lower and upper confidence intervals. Positive sets refers to the number of trawl sets that caught Pacific Cod. SYN QCS = Queen Charlotte Sound synoptic bottom trawl survey; SYN WCVI = West Coast Vancouver Island synoptic bottom trawl survey; SYN HS = Hecate Strait synoptic bottom trawl survey; OTHER HS MSA = Hecate Strait Multispecies Assemblage survey."}
gfplot::tidy_survey_index(dat$survey_index,
  survey = c("SYN QCS", "SYN WCVI", "SYN HS", "OTHER HS MSA")) %>%
  plot_survey_index()
```

```{r tri-fig9, fig.cap="Biomass estimates for Pacific Cod in the International North Pacific Fisheries Commission Vancouver region (Canadian waters only) with 95\\% error bars estimated from 1000 bootstraps."}
knitr::include_graphics(here::here("report/paul-figs/fig9.png"))
```

```{r cpue-funcs}
source(here::here('R/cpue-functions.R'))
```

```{r cpue-params}
params <- list()
params$species_proper <- "Pacific Cod"
params$april1_year <- TRUE
params$area <- c("5[ABCD]+", "3[CD]+")
params$area_name <- c("5ABCD", "3CD")
params$skip_single_variable_models <- FALSE
```

```{r cpue-run-historic, message=FALSE, warning=FALSE, results='hide'}
params$era <- "historic"
source(here::here("R/cpue.R"))
dfleet_hist <- dfleet
gg_cpue_hist <- gg_cpue
cpue_pred_hist <- predictions
arith_cpue_hist <- arith_cpue
m_historic <- readRDS(here::here("data/generated/cpue-models-pcod-historic.rds"))
```

```{r cpue-run-modern, message=FALSE, warning=FALSE, results='hide'}
params$era <- "modern"
source(here::here("R/cpue.R"))
dfleet_modern <- dfleet
gg_cpue_modern <- gg_cpue
cpue_pred_modern <- predictions
arith_cpue_modern <- arith_cpue
m_modern <- readRDS(here::here("data/generated/cpue-models-pcod-modern.rds"))
```

```{r cpue-save}
readr::write_csv(cpue_pred_modern, here::here("data/generated/cpue-predictions-modern.csv"))
readr::write_csv(cpue_pred_hist, here::here("data/generated/cpue-predictions-historical.csv"))
```

```{r cpue-index-ts-hist, fig.asp=1.15, fig.cap="Commercial trawl CPUE standardization models. Throughout, the black line and shaded region indicate a CPUE index with only a year predictor. The coloured line and shaded ribbons indicate indices that have been standardized by one or more predictors. The first three rows illustrate standardization models that include a single predictor listed on the right. The second last row illustrates a standardization model that includes all the predictors in one model. The last row illustrates a standardization model that includes all the predictors plus locality-by-year (space-time) random effects. Locality and locality-year interactions are fit as random effects and all other variables are fit as fixed effects."}
make_cpue_ts_dat(cpue_pred_hist) %>% make_cpue_ts_plot() +
  ggtitle("1956-1995 CPUE") +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
```

(ref:caption-cpue-index-ts-modern) Same as Figure \@ref(fig:cpue-index-ts-hist) but for the 1996 to 2019 data. Locality, vessel, and locality-year interactions are fit as random effects and all other variables are fit as fixed effects.

```{r cpue-index-ts-modern, fig.asp=1.55, fig.cap="(ref:caption-cpue-index-ts-modern)", out.width="5.2in", fig.width=6.5}
make_cpue_ts_dat(cpue_pred_modern) %>% make_cpue_ts_plot() +
  ggtitle("1996+ CPUE") +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
```

```{r}
mw5ABCD <- read_csv(here::here("data/results/AnnualMeanWeight_5ABCD.csv"))
mw3CD <- read_csv(here::here("data/results/AnnualMeanWeight_3CD.csv"))
```

```{r meanweight-3cd, fig.cap="Mean weight (kg) in the commercial catch for Area 3CD", out.width="5.2in", fig.width=6.5}

df <- mw3CD
ggplot(data=df, aes(x=year,y=mean_weight, group=1)) +
  geom_line(lwd=1, colour=2) +
  ylim(0,1.1*max(df$mean_weight)) +
  theme(plot.title=element_text(size=14,face="bold",hjust=0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  scale_x_continuous(breaks=seq(min(df$year),max(df$year),by=5)) +
  labs(x= "Fishing Year", y = "Annual Mean Weight (Kg)", title="Area 3CD")
```

```{r meanweight-5abcd, fig.cap="Mean weight (kg) in the commercial catch for Area 5ABCD", out.width="5.2in", fig.width=6.5}
df <- mw5ABCD
ggplot(data=df, aes(x=year,y=mean_weight, group=1)) +
  geom_line(lwd=1, colour=2) +
  ylim(0,1.1*max(df$mean_weight)) +
  theme(plot.title=element_text(size=14,face="bold",hjust=0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  scale_x_continuous(breaks=seq(min(df$year),max(df$year),by=5)) +
  labs(x= "Fishing Year", y = "Annual Mean Weight (Kg)", title="Area 5ABCD")
```


