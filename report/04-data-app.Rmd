\clearpage

`r if(knitr:::is_latex_output()) '\\Appendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

\vspace{50pt}

# Data

## Catch

### Area 3CD

```{r tab-catch-3cd}
catch.table(catch.3,
            catch.3.discards,
            area = "3CD",
 cap = paste0("Reported catch (mt) of Pacific Cod in Area 3CD ",
              "by Canada and the USA, ",
              min(catch.3$year), "--", max(catch.3$year),
              ". The reported discards for the period ", min(catch.3$year),
              "--1995 are ",
              "unrepresentative of true discarding because the estimates were taken ",
              "from logbooks. Discard estimates since 1996 are based on at-sea ",
              "observations and are considered to be more representative of true discarding."), french=french)
```

\clearpage

```{r fig-catch-3cd, fig.cap="Catch for Area 3CD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.3, french=french)
```

```{r fig-discards-3cd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 3CD."}
discards.plot(catch.3, french=french)
```

<!--

```{r fig-catch-3cd-gear, fig.cap="Canadian catch for Area 3CD by gear. Catch includes at-sea releases."}
make.catches.plot.gear(catch.3.gear, french=french)
```

-->

```{r fig-catch-3cd-gear-recent, fig.cap="Canadian catch for Area 3CD by gear since 1996. Catch includes at-sea releases."}
catch.3.gear.recent <- catch.3.gear %>% dplyr::filter(year>1995) %>%                 dplyr::filter(year<2021)
make.catches.plot.gear(catch.3.gear.recent, french=french)
```

<!--

```{r fig-catch-3cd-gear-vessel, fig.cap="Canadian catch for Area 3CD by vessel, showing catch from freezer trawlers. Catch includes at-sea releases."}
# This plot is for exploring, do not publish
 freezer <- c("NORTHERN ALLIANCE", "OSPREY NO 1", "VIKING ENTERPRISE", "RAW SPIRIT", "VIKING ALLIANCE")
 catch.3.gear.vessel.freezer <- catch.3.gear.vessel %>% 
         filter(vessel_name %in% freezer)
 
make.catches.plot.vessel(catch.3.gear.vessel.freezer)
```

-->

\clearpage

### Area 5ABCD

```{r tab-catch-5abcd}
catch.table(catch.5,
            catch.5.discards,
            area = "5ABCD",
 cap = paste0("Reported catch (mt) of Pacific Cod in Area 5ABCD ",
              "by Canada and the USA, ",
              min(catch.5$year), "--", max(catch.5$year),
              ". The reported discards for the period ", min(catch.5$year),
              "--1995 are ",
              "unrepresentative of true discarding because the estimates were taken ",
              "from logbooks. Discard estimates since 1996 are based on at-sea ",
              "observations and are considered to be more representative of true discarding."),      french=french)

```

\clearpage

```{r fig-catch-5abcd, fig.cap="Catch for Area 5ABCD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5, french=french)
```


```{r fig-discards-5abcd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5ABCD."}
discards.plot(catch.5, french=french)
```

<!--

```{r fig-catch-5ab, fig.cap="Catch for Area 5AB. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5ab, french=french)
```

```{r fig-discards-5ab, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5AB."}
discards.plot(catch.5ab, french=french)
```

```{r fig-catch-5cd, fig.cap="Catch for Area 5CD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.5cd, french=french)
```

```{r fig-discards-5cd, fig.cap="Estimated at-sea releases of Pacific Cod by bottom trawlers for Area 5CD."}
discards.plot(catch.5cd, french=french)
```

-->

\clearpage

## Fishery-independent indices of abundance {#app:data-summary}

### Canadian bottom trawl surveys

The models were fit to several relative indices of abundance for Pacific Cod (Table \@ref(tab:surv-canadian-table) and Figure (fig:surv-canadian)).
All survey indices were calculated using a swept area analysis, documented in Appendix A of @forrest2020.

Abundance in Area 3CD (\@ref(fig:fig-map)) is indexed by the West Coast Vancouver Island Synoptic Survey.
The survey was first conducted in 2004 and is conducted in alternating (even-numbered) years.
Due to the COVID-19 pandemic there was no survey in 2020.

Abundance in Area 5AB (\@ref(fig:fig-map)) is indexed by the Queen Charlotte Sound Synoptic Survey.
The survey was first conducted in 2003 and 2004, and then in odd years since 2005.
Abundance in Area 5CD (\@ref(fig:fig-map)) was indexed by the Hecate Strait Multispecies Assemblage Survey in 1984, 1987, 1989, 1991, 1993, 1995, 1996, 1998, 2000, 2002, and 2003.
Since 2005, it has been indexed in odd-numbered years by the Hecate Strait Synoptic Survey.

Details on spatial extent and depth strata of all surveys are also provided in Appendix A of @forrest2020.

\clearpage

```{r surv-canadian-table, results='asis'}
dplyr::filter(dat$survey_index, survey_abbrev %in%
  c("SYN QCS", "SYN WCVI", "SYN HS", "OTHER HS MSA")) %>%
  dplyr::select(survey_abbrev, year, biomass, re, lowerci, upperci, num_sets, num_pos_sets) %>%
  dplyr::mutate(lowerci = round(lowerci/1000, 1), upperci = round(upperci/1000, 1),
    biomass = round(biomass/1000, 1), re = round(re, 2)) %>%
  dplyr::rename(`Survey abbrev.` = survey_abbrev, Year = year, Biomass = biomass,
    CV = re, `Lower CI` = lowerci, `Upper CI` = upperci, Sets = num_sets, `Positive sets` = num_pos_sets) %>%
  dplyr::arrange(`Survey abbrev.`, Year) %>%
  knitr::kable(caption = "Pacific Cod survey data for Canadian trawl surveys in metric tons (without accounting for survey catchability). Positive sets refers to the number of trawl sets that caught Pacific Cod.", booktabs = TRUE, linesep = "", 
    format = "pandoc")
```

\clearpage

```{r surv-canadian, fig.cap="Pacific Cod survey data for Canadian trawl surveys. Shown is relative biomass and associated lower and upper confidence intervals. Positive sets refers to the number of trawl sets that caught Pacific Cod."}
gfplot::tidy_survey_index(dat$survey_index,
  survey = c("SYN QCS", "SYN WCVI", "SYN HS", "OTHER HS MSA")) %>%
  plot_survey_index()
```

\clearpage

#### NMFS Triennial Survey (in Canadian waters)

An additional relative abundance index for Area 3CD was developed using data from the
National Marine Fisheries Service (NMFS) Triennial survey operated off the lower half of West Coast Vancouver Island (Figure \@ref(fig:tri-fig9)).
See Appendix A of @forrest2018 for complete details.

```{r tri-fig9, fig.cap="Biomass estimates for three series of Pacific Cod in the INPFC Vancouver region (total region, Canadian waters only, US waters only) with 95\\% error bars estimated from 1000 bootstraps."}
insert_paul_figure <- function(n) {
  knitr::include_graphics(here::here("report", "paul-figs", paste0("paul", n, ".png")), dpi = NA)
}

insert_paul_figure(9)
```


\clearpage

## Commercial CPUE

The models were also fit to standardized commercial CPUE indices for the historical (1956:1995) and modern (1996:2019) periods (Figures \@ref(fig:cpue-index-ts-hist) and \@ref(fig:cpue-index-ts-modern), respectively).
The indices were developed using the Tweedie standardized generalized linear mixed model (GLMM) described in detail in Appendix B of @forrest2020.
The historical GLMMs included predictors for depth, locality, month, and a locality-year interaction (Figure \@ref(fig:cpue-index-ts-hist)).
The modern GLMMs included predictors for depth, latitude, locality, month, vessel and a locality-vessel interaction (Figure )\@ref(fig:cpue-index-ts-modern)).

*TODO: clarify which the model is fit to*



```{r cpue-funcs}
source(here::here('R/cpue-functions.R'))
```

```{r cpue-params}
params <- list()
params$species_proper <- "Pacific Cod"
params$april1_year <- TRUE
params$area <- c("5[ABCD]+", "3[CD]+")
params$area_name <- c("5ABCD", "3CD")
params$skip_single_variable_models <- FALSE
```

```{r cpue-run-historic, message=FALSE, warning=FALSE, results='hide'}
params$era <- "historic"
source(here::here("R/cpue.R"))
dfleet_hist <- dfleet
gg_cpue_hist <- gg_cpue
cpue_pred_hist <- predictions
arith_cpue_hist <- arith_cpue
m_historic <- readRDS(here::here("data/generated/cpue-models-pcod-historic.rds"))
```

```{r cpue-run-modern, message=FALSE, warning=FALSE, results='hide'}
params$era <- "modern"
source(here::here("R/cpue.R"))
dfleet_modern <- dfleet
gg_cpue_modern <- gg_cpue
cpue_pred_modern <- predictions
arith_cpue_modern <- arith_cpue
m_modern <- readRDS(here::here("data/generated/cpue-models-pcod-modern.rds"))
```

```{r cpue-save}
readr::write_csv(cpue_pred_modern, here::here("data/generated/cpue-predictions-modern.csv"))
readr::write_csv(cpue_pred_hist, here::here("data/generated/cpue-predictions-historical.csv"))
```

```{r cpue-index-ts-hist, fig.asp=1.15, fig.cap="Commercial trawl CPUE standardization models. Throughout, the black line and shaded region indicate a CPUE index with only a year predictor. The coloured line and shaded ribbons indicate indices that have been standardized by one or more predictors. The first three rows illustrate standardization models that include a single predictor listed on the right. The second last row illustrates a standardization model that includes all the predictors in one model. The last row illustrates a standardization model that includes all the predictors plus locality-by-year (space-time) random effects. Locality and locality-vessel interactions are fit as random effects and all other variables are fit as fixed effects."}
make_cpue_ts_dat(cpue_pred_hist) %>% make_cpue_ts_plot() +
  ggtitle("1956-1995 CPUE") +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
```

(ref:caption-cpue-index-ts-modern) Same as Figure \@ref(fig:cpue-index-ts-hist) but for the 1996 to 2017 data. Locality, vessel, and locality-vessel interactions are fit as random effects and all other variables are fit as fixed effects.

```{r cpue-index-ts-modern, fig.asp=1.55, fig.cap="(ref:caption-cpue-index-ts-modern)", out.width="5.2in", fig.width=6.5}
make_cpue_ts_dat(cpue_pred_modern) %>% make_cpue_ts_plot() +
  ggtitle("1996+ CPUE") +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
```

\clearpage

## Annual mean weight in commercial catch

*TODO: Add text here*

```{r}
mw5ABCD <- read_csv(here::here("data/results/AnnualMeanWeight_5ABCD.csv"))
mw3CD <- read_csv(here::here("data/results/AnnualMeanWeight_3CD.csv"))
```


### Area 3CD

```{r meanweight-3cd, fig.cap="Mean weight (kg) in the commercial catch for Area 3CD", out.width="5.2in", fig.width=6.5}

df <- mw3CD
ggplot(data=df, aes(x=year,y=mean_weight, group=1)) +
  geom_line(lwd=1, colour=2) +
  ylim(0,1.1*max(df$mean_weight)) +
  theme(plot.title=element_text(size=14,face="bold",hjust=0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  scale_x_continuous(breaks=seq(min(df$year),max(df$year),by=5)) +
  labs(x= "Fishing Year", y = "Annual Mean Weight (Kg)", title="Area 3CD")
```

\clearpage

### Area 5ABCD

```{r meanweight-5abcd, fig.cap="Mean weight (kg) in the commercial catch for Area 5ABCD", out.width="5.2in", fig.width=6.5}
df <- mw5ABCD
ggplot(data=df, aes(x=year,y=mean_weight, group=1)) +
  geom_line(lwd=1, colour=2) +
  ylim(0,1.1*max(df$mean_weight)) +
  theme(plot.title=element_text(size=14,face="bold",hjust=0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  scale_x_continuous(breaks=seq(min(df$year),max(df$year),by=5)) +
  labs(x= "Fishing Year", y = "Annual Mean Weight (Kg)", title="Area 5ABCD")
```

